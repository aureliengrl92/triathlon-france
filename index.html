<!doctype html>

<html lang="fr">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Triathlons en France — Carte filtrable</title>

  <link rel="stylesheet" href=https://unpkg.com/leaflet@1.9.4/dist/leaflet.css />

  <link rel="stylesheet" href=https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css />

  <link rel="stylesheet" href=https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css />

  <style>

    html,body{height:100%;margin:0}

    #app{display:grid;grid-template-rows:auto 1fr;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

    header{padding:.8rem 1rem;border-bottom:1px solid #eee}

    .controls{display:grid;grid-template-columns:repeat(5,minmax(120px,1fr));gap:.6rem;align-items:end}

    .control{display:flex;flex-direction:column;gap:.25rem}

    .control select{padding:.5rem}

    #map{height:100%}

    .small{font-size:.9rem;color:#555}

    @media (max-width: 960px){ .controls{grid-template-columns:repeat(2,1fr)} }

  </style>

</head>

<body>

<div id="app">

  <header>

    <h1>Triathlons en France — Carte ouverte</h1>

    <div class="controls">

      <div class="control">

        <label for="region">Région</label>

        <select id="region"><option value="">Toutes</option></select>

      </div>

      <div class="control">

        <label for="format">Format</label>

        <select id="format">

          <option value="">Tous</option>

          <option value="XS">XS</option><option value="S">S</option>

          <option value="M">M</option><option value="L">L</option><option value="XL">XL</option>

        </select>

      </div>

      <div class="control">

        <label for="month">Mois</label>

        <select id="month">

          <option value="">Tous</option>

          <option value="1">Janvier</option><option value="2">Février</option><option value="3">Mars</option>

          <option value="4">Avril</option><option value="5">Mai</option><option value="6">Juin</option>

          <option value="7">Juillet</option><option value="8">Août</option><option value="9">Septembre</option>

          <option value="10">Octobre</option><option value="11">Novembre</option><option value="12">Décembre</option>

        </select>

      </div>

      <div class="control">

        <label for="profile">Parcours</label>

        <select id="profile">

          <option value="">Tous</option>

          <option value="flat">Plat</option>

          <option value="rolling">Vallonné</option>

          <option value="mountain">Montagne</option>

        </select>

      </div>

      <div class="control">

        <button id="reset" type="button">Réinitialiser</button>

      </div>

    </div>

    <div id="counter" class="small" aria-live="polite"></div>

  </header>

  <div id="map" role="region" aria-label="Carte des triathlons"></div>

</div>

 

<script src=https://unpkg.com/leaflet@1.9.4/dist/leaflet.js></script>

<script src=https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js></script>

<script>

const map = L.map('map').setView([46.6, 2.5], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

const clusters = L.markerClusterGroup();

let currentLayer = null;

let DATA = {type:"FeatureCollection",features:[]};

 

const FORMAT_COLORS = { XS:'#22c55e', S:'#3b82f6', M:'#a855f7', L:'#ef4444', XL:'#f59e0b' };

const $region = document.getElementById('region');

const $format = document.getElementById('format');

const $month  = document.getElementById('month');

const $profile= document.getElementById('profile');

const $reset  = document.getElementById('reset');

const $counter= document.getElementById('counter');

 

function monthFromISO(iso){ if(!iso) return null; const d=new Date(iso); return isNaN(d)?null:d.getMonth()+1; }

function markerForFeature(f){

  const p=f.properties||{}; const color = FORMAT_COLORS[p.format] || '#3388ff';

  const icon = L.divIcon({className:'custom-pin', html:`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0Z"/><circle cx="12" cy="10" r="3" fill="${color}"></circle></svg>`});

  const m=L.marker([f.geometry.coordinates[1], f.geometry.coordinates[0]], {icon});

  const dateStr=p.start_date?new Date(p.start_date).toLocaleDateString('fr-FR'):'';

  const profileLabel=p.profile==='flat'?'Plat':p.profile==='mountain'?'Montagne':'Vallonné';

  m.bindPopup(`<strong>${p.name||'Épreuve'}</strong><br>

    ${p.format||''} • ${dateStr}<br>

    ${p.city||''} • ${p.region||''}<br>

    Parcours : ${profileLabel}<br>

    ${p.url?`<a href="${p.url}" target="_blank" rel="noopener">Détails</a>`:''}

    ${p.registration_url?` · <a href="${p.registration_url}" target="_blank" rel="noopener">Inscription</a>`:''}`);

  return m;

}

function fillRegionsFrom(json){

  $region.innerHTML = '<option value="">Toutes</option>';

  const set = new Set(json.features.map(f=>f.properties?.region).filter(Boolean));

  [...set].sort((a,b)=>a.localeCompare(b,'fr')).forEach(r=>{

    const opt=document.createElement('option'); opt.value=r; opt.textContent=r; $region.appendChild(opt);

  });

}

function applyFilters(){

  if(currentLayer){ clusters.removeLayer(currentLayer); }

  const region=$region.value, format=$format.value, month=$month.value?+$month.value:null, profile=$profile.value;

  const filtered = DATA.features.filter(f=>{

    const p=f.properties||{};

    if(region && p.region!==region) return false;

    if(format && p.format!==format) return false;

    if(profile && p.profile!==profile) return false;

    if(month){ const m=monthFromISO(p.start_date); if(m!==month) return false; }

    return true;

  });

  const layer = L.featureGroup(filtered.map(markerForFeature));

  currentLayer=layer; clusters.clearLayers(); clusters.addLayer(layer); map.addLayer(clusters);

  try{ if(filtered.length){ map.fitBounds(layer.getBounds().pad(0.2)); } }catch{}

  $counter.textContent = `${filtered.length} épreuve${filtered.length>1?'s':''} affichée${filtered.length>1?'s':''}`;

}

$region.addEventListener('change', applyFilters);

$format.addEventListener('change', applyFilters);

$month.addEventListener('change', applyFilters);

$profile.addEventListener('change', applyFilters);

$reset.addEventListener('click', ()=>{ $region.value=''; $format.value=''; $month.value=''; $profile.value=''; applyFilters(); });

 

// Charge le GeoJSON externe (assure-toi que le fichier existe bien)

fetch('./data/triathlons.geojson')

  .then(r => r.json())

  .then(json => { DATA=json; fillRegionsFrom(DATA); applyFilters(); })

  .catch(err => {

    console.error('Erreur chargement données', err);

    document.getElementById('map').innerHTML = "<p style='padding:1rem;'>Impossible de charger <code>data/triathlons.geojson</code>. Vérifie le dossier <code>data/</code> et le nom du fichier.</p>";

  });

</script>

</body>

</html>
